#!/bin/sh
set -eu

echo "Test logs are here: /tmp/cf-operator-tests.log"

if [ -z ${TEST_NAMESPACE+x} ]; then
  TEST_NAMESPACE="test$(date +%s)"
  export TEST_NAMESPACE

  remove_namespace() {
    kubectl delete namespace --wait=false --grace-period=60 "$TEST_NAMESPACE"
  }
  trap remove_namespace EXIT

  kubectl create namespace "$TEST_NAMESPACE"
fi

bin/apply-crds

kubectl get customresourcedefinitions

pkgs=$(go list ./... 2> /dev/null)
deps=`echo ${pkgs} | tr ' ' ","`
ginkgo -cover -coverpkg "$deps" e2e/

# Send code coverage results to coveralls.io
gocoverage
goveralls -coverprofile profile.cov -service concourse -repotoken "$COVERALLS_TOKEN"