#!/bin/bash

GIT_ROOT="${GIT_ROOT:-$(git rev-parse --show-toplevel)}"
. "${GIT_ROOT}/bin/include/versioning"
. "${GIT_ROOT}/.envrc"

if [ -z ${DOCKER_IMAGE_TAG+x} ]; then
  DOCKER_IMAGE_TAG=${VERSION_TAG}
  export DOCKER_IMAGE_TAG
fi

set -o errexit

export GOOS=linux
export GOARCH=amd64
export BINARY_NAME=cf-operator-linux-amd64

"${GIT_ROOT}/bin/build"

docker build "${GIT_ROOT}" \
  --file "${GIT_ROOT}/Dockerfile" \
  --tag "${OPERATOR_DOCKER_ORGANIZATION}/cf-operator:${DOCKER_IMAGE_TAG}"

docker save "${OPERATOR_DOCKER_ORGANIZATION}/cf-operator:${DOCKER_IMAGE_TAG}"\
  --output "${GIT_ROOT}/binaries/cf-operator-image.tgz"

if type -a minikube >/dev/null 2>/dev/null; then
  if ! dockerenv=$(minikube docker-env); then
    echo "Minikube not running. Skipping loading image into Minikube's Docker daemon..."
    exit 0
  fi
  eval "${dockerenv}"
  docker load --input "${GIT_ROOT}/binaries/cf-operator-image.tgz"
fi
